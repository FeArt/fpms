"use strict";var ApplicationConfiguration=function(){var a="fpms",b=["ngResource","ngCookies","ngAnimate","ngTouch","ngSanitize","ui.router","ui.bootstrap","ui.utils","datatables","mgcrea.ngStrap","ngLocale","highcharts-ng"],c=function(b,c){angular.module(b,c||[]),angular.module(a).requires.push(b)};return{applicationModuleName:a,applicationModuleVendorDependencies:b,registerModule:c}}();angular.module(ApplicationConfiguration.applicationModuleName,ApplicationConfiguration.applicationModuleVendorDependencies),angular.module(ApplicationConfiguration.applicationModuleName).config(["$locationProvider",function(a){a.hashPrefix("!")}]),angular.element(document).ready(function(){"#_=_"===window.location.hash&&(window.location.hash="#!"),angular.bootstrap(document,[ApplicationConfiguration.applicationModuleName])}),ApplicationConfiguration.registerModule("apps"),ApplicationConfiguration.registerModule("core"),ApplicationConfiguration.registerModule("users"),angular.module("apps").run(["Menus",function(a){a.addMenuItem("topbar","我的应用","apps","dropdown","/apps(/create)?","false",["user"]),a.addSubMenuItem("topbar","apps","应用列表","apps"),a.addSubMenuItem("topbar","apps","添加应用","apps/create"),a.addMenuItem("topbar","应用列表","apps","item","/apps","false",["admin"])}]),angular.module("apps").config(["$datepickerProvider",function(a){angular.extend(a.defaults,{dateFormat:"yyyy-MM-dd"})}]),angular.module("apps").config(["$selectProvider",function(a){angular.extend(a.defaults,{animation:"am-flip-x"})}]),angular.module("apps").config(["$tooltipProvider",function(a){angular.extend(a.defaults,{animation:"am-flip-x",trigger:"hover",placement:"bottom",type:"success"})}]),angular.module("apps").config(["$stateProvider",function(a){a.state("listApps",{url:"/apps",templateUrl:"modules/apps/views/app/list-apps.client.view.html"}).state("createApp",{url:"/apps/create",templateUrl:"modules/apps/views/app/create-app.client.view.html"}).state("viewApp",{url:"/apps/:appId",templateUrl:"modules/apps/views/app/view-app.client.view.html"}).state("editApp",{url:"/apps/:appId/edit",templateUrl:"modules/apps/views/app/edit-app.client.view.html"})}]),angular.module("apps").controller("AppsController",["$scope","$stateParams","$location","Authentication","Apps","DTOptionsBuilder","$http",function(a,b,c,d,e,f,g){a.authentication=d,a.type="java",a.types=["java","node.js","android","ios"],d.user&&(a.showName="admin"===d.user.roles[0]?!0:!1),a.script='<script type="text/javascript">var fp = document.createElement("script");fp.type = "text/javascript";fp.async = true;fp.src = "http://'+c.host()+":"+c.port()+"/rookie.js/"+b.appId+'";var s = document.getElementsByTagName("script")[0];s.parentNode.insertBefore(fp, s);</script>',a.create=function(){var b=new e({name:this.name,type:this.type,host:this.host});b.$save(function(b){c.path("apps/"+b._id),a.name="",a.type="java",a.host=""},function(b){a.error=b.data.message})},a.remove=function(b){if(b){b.$remove();for(var d in a.apps)a.apps[d]===b&&a.apps.splice(d,1)}else a.app.$remove(function(){c.path("apps")})},a.update=function(){var b=a.app;b.$update(function(){c.path("apps/"+b._id)},function(b){a.error=b.data.message})},a.find=function(){a.apps=e.query()},a.findOne=function(){a.app=e.get({appId:b.appId}),Highcharts.setOptions({lang:{contextButtonTitle:"导出",printChart:"打印图表",downloadJPEG:"下载JPEG",downloadPDF:"下载PDF",downloadPNG:"下载PNG",downloadSVG:"下载SVG"}}),g.get("pages/"+b.appId).success(function(b){if(a.pagesNum=b.length||0,b.length){a.showChart=!0,a.pages=b,a.selectPage=a.pages[0];var c=new Date;a.nowDate=Date.UTC(c.getFullYear(),c.getMonth(),c.getDate()),a.fromDate=a.nowDate-1296e6,a.untilDate=new Date(a.nowDate);var d=function(){var b=Date.parse(a.untilDate)+864e5;g.get("timings",{params:{pageId:a.selectPage._id,fromDate:new Date(a.fromDate),untilDate:new Date(b)}}).success(function(b){a.chartConfig.series[0].data=b.numData,a.chartConfig.series[1].data=b.pageLoadData,a.chartConfig.series[2].data=b.networkData,a.chartConfig.series[3].data=b.backendData,a.chartConfig.series[4].data=b.frontendData,a.statisticData=b.statisticData})};d(),a.chartConfig={options:{tooltip:{xDateFormat:"%Y-%m-%d",shared:!0},plotOptions:{series:{cursor:"pointer",point:{events:{click:function(){g.get("timings",{params:{pageId:a.selectPage._id,dateNumber:this.category}}).success(function(b){a.details=b.data})}}}}}},credits:{enabled:!1},xAxis:{title:{text:"日期",align:"high"},type:"datetime",dateTimeLabelFormats:{day:"%m.%d"},tickInterval:864e5},yAxis:[{title:{text:"耗时（ms）"}},{title:{text:"请求总数",style:{color:Highcharts.getOptions().colors[0]}},labels:{style:{color:Highcharts.getOptions().colors[0]}},allowDecimals:!1,opposite:!0}],series:[{name:"请求总数",type:"column",yAxis:1,data:[]},{name:"平均总耗时",type:"spline",tooltip:{valueSuffix:" ms"},data:[]},{name:"平均网络耗时",type:"spline",tooltip:{valueSuffix:" ms"},data:[]},{name:"平均后端耗时",type:"spline",tooltip:{valueSuffix:" ms"},data:[]},{name:"平均前端耗时",type:"spline",tooltip:{valueSuffix:" ms"},data:[]}],title:{text:"页面总体概况"}},a.refrashChart=d}else a.showChart=!1})},a.dtOptions=f.newOptions().withLanguage({sLengthMenu:"每页显示 _MENU_ 条数据",sInfo:"从 _START_ 到 _END_ /共 _TOTAL_ 条数据",sInfoEmpty:"没有数据",sInfoFiltered:"(从 _MAX_ 条数据中检索)",sZeroRecords:"没有检索到数据",sSearch:"检索:",oPaginate:{sFirst:"首页",sPrevious:"上一页",sNext:"下一页",sLast:"末页"}}).withBootstrap(),a.canUpdate=function(){return a.appForm.$valid},a.removeErr=function(){a.error=!1},a.back=function(){window.history.back()},a.findTiming=function(b){g.get("timings/"+b).success(function(b){a.timingData=b,a.resources=b.allResourcesCalc,a.timingErrs=b.errs})},a.pageLoadTooltip={title:"页面请求加载总耗时"},a.networkTooltip={title:"包括页面跳转、域名查询、请求连接耗时"},a.backendTooltip={title:"包括从客户端发出请求到服务端完成响应耗时"},a.frontendTooltip={title:"包括DOM加载、页面渲染耗时"}}]),angular.module("apps").directive("myConfirmClick",[function(){return{priority:-1,restrict:"A",link:function(a,b,c){b.bind("click",function(a){var b=c.myConfirmClick;b&&!confirm(b)&&(a.stopImmediatePropagation(),a.preventDefault())})}}}]),angular.module("apps").factory("Apps",["$resource",function(a){return a("apps/:appId",{appId:"@_id"},{update:{method:"PUT"}})}]),angular.module("core").config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/"),a.state("home",{url:"/",templateUrl:"modules/core/views/home.client.view.html"})}]),angular.module("core").controller("HeaderController",["$scope","Authentication","Menus",function(a,b,c){a.authentication=b,a.isCollapsed=!1,a.menu=c.getMenu("topbar"),a.toggleCollapsibleMenu=function(){a.isCollapsed=!a.isCollapsed},a.$on("$stateChangeSuccess",function(){a.isCollapsed=!1})}]),angular.module("core").controller("HomeController",["$scope","Authentication",function(a,b){a.authentication=b}]),angular.module("core").service("Menus",[function(){this.defaultRoles=["*"],this.menus={};var a=function(a){if(!a)return this.isPublic;if(~this.roles.indexOf("*"))return!0;for(var b in a.roles)for(var c in this.roles)if(this.roles[c]===a.roles[b])return!0;return!1};this.validateMenuExistance=function(a){if(a&&a.length){if(this.menus[a])return!0;throw new Error("Menu does not exists")}throw new Error("MenuId was not provided")},this.getMenu=function(a){return this.validateMenuExistance(a),this.menus[a]},this.addMenu=function(b,c,d){return this.menus[b]={isPublic:c||!1,roles:d||this.defaultRoles,items:[],shouldRender:a},this.menus[b]},this.removeMenu=function(a){this.validateMenuExistance(a),delete this.menus[a]},this.addMenuItem=function(b,c,d,e,f,g,h,i){return this.validateMenuExistance(b),this.menus[b].items.push({title:c,link:d,menuItemType:e||"item",menuItemClass:e,uiRoute:f||"/"+d,isPublic:null===g||"undefined"==typeof g?this.menus[b].isPublic:g,roles:null===h||"undefined"==typeof h?this.menus[b].roles:h,position:i||0,items:[],shouldRender:a}),this.menus[b]},this.addSubMenuItem=function(b,c,d,e,f,g,h,i){this.validateMenuExistance(b);for(var j in this.menus[b].items)this.menus[b].items[j].link===c&&this.menus[b].items[j].items.push({title:d,link:e,uiRoute:f||"/"+e,isPublic:null===g||"undefined"==typeof g?this.menus[b].items[j].isPublic:g,roles:null===h||"undefined"==typeof h?this.menus[b].items[j].roles:h,position:i||0,shouldRender:a});return this.menus[b]},this.removeMenuItem=function(a,b){this.validateMenuExistance(a);for(var c in this.menus[a].items)this.menus[a].items[c].link===b&&this.menus[a].items.splice(c,1);return this.menus[a]},this.removeSubMenuItem=function(a,b){this.validateMenuExistance(a);for(var c in this.menus[a].items)for(var d in this.menus[a].items[c].items)this.menus[a].items[c].items[d].link===b&&this.menus[a].items[c].items.splice(d,1);return this.menus[a]},this.addMenu("topbar")}]),angular.module("users").config(["$httpProvider",function(a){a.interceptors.push(["$q","$location","Authentication",function(a,b,c){return{responseError:function(d){switch(d.status){case 401:c.user=null,b.path("signin");break;case 403:}return a.reject(d)}}}])}]),angular.module("users").run(["Menus",function(a){a.addMenuItem("topbar","用户列表","users","item","/users","false",["admin"])}]),angular.module("users").config(["$stateProvider",function(a){a.state("profile",{url:"/settings/profile",templateUrl:"modules/users/views/settings/edit-profile.client.view.html"}).state("password",{url:"/settings/password",templateUrl:"modules/users/views/settings/change-password.client.view.html"}).state("signup",{url:"/signup",templateUrl:"modules/users/views/authentication/signup.client.view.html"}).state("signin",{url:"/signin",templateUrl:"modules/users/views/authentication/signin.client.view.html"}).state("forgot",{url:"/password/forgot",templateUrl:"modules/users/views/password/forgot-password.client.view.html"}).state("reset-invalid",{url:"/password/reset/invalid",templateUrl:"modules/users/views/password/reset-password-invalid.client.view.html"}).state("reset-success",{url:"/password/reset/success",templateUrl:"modules/users/views/password/reset-password-success.client.view.html"}).state("reset",{url:"/password/reset/:token",templateUrl:"modules/users/views/password/reset-password.client.view.html"}).state("listUsers",{url:"/users",templateUrl:"modules/users/views/settings/list-users.client.view.html"})}]),angular.module("users").controller("AuthenticationController",["$scope","$http","$location","Authentication",function(a,b,c,d){a.authentication=d,a.authentication.user&&c.path("/"),a.signup=function(){b.post("/auth/signup",a.credentials).success(function(){a.success=!0}).error(function(b){a.error=b.message})},a.signin=function(){b.post("/auth/signin",a.credentials).success(function(b){a.authentication.user=b,c.path("/")}).error(function(b){a.error=b.message})}}]),angular.module("users").controller("PasswordController",["$scope","$stateParams","$http","$location","Authentication",function(a,b,c,d,e){a.authentication=e,a.authentication.user&&d.path("/"),a.askForPasswordReset=function(){a.success=a.error=null,c.post("/auth/forgot",a.credentials).success(function(b){a.credentials=null,a.success=b.message}).error(function(b){a.credentials=null,a.error=b.message})},a.resetUserPassword=function(){a.success=a.error=null,c.post("/auth/reset/"+b.token,a.passwordDetails).success(function(b){a.passwordDetails=null,e.user=b,d.path("/password/reset/success")}).error(function(b){a.error=b.message})},a.back=function(){window.history.back()}}]),angular.module("users").controller("SettingsController",["$scope","$http","$location","Users","Authentication","DTOptionsBuilder",function(a,b,c,d,e,f){a.user=e.user,a.user||c.path("/"),a.updateUserProfile=function(b){if(b){a.success=a.error=null;var c=new d(a.user);c.$update(function(b){a.success=!0,e.user=b},function(b){a.error=b.data.message})}else a.submitted=!0},a.changeUserPassword=function(){a.success=a.error=null,b.post("/users/password",a.passwordDetails).success(function(){a.success=!0,a.passwordDetails=null}).error(function(b){a.error=b.message})},a.find=function(){a.users=d.query()},a.dtOptions=f.newOptions().withLanguage({sLengthMenu:"每页显示 _MENU_ 条数据",sInfo:"从 _START_ 到 _END_ /共 _TOTAL_ 条数据",sInfoEmpty:"没有数据",sInfoFiltered:"(从 _MAX_ 条数据中检索)",sZeroRecords:"没有检索到数据",sSearch:"检索:",oPaginate:{sFirst:"首页",sPrevious:"上一页",sNext:"下一页",sLast:"末页"}}).withBootstrap(),a.change=function(b){a.success=a.error=null,b.$update(function(){a.success=!0},function(b){a.error=b.data.message})},a.back=function(){window.history.back()}}]),angular.module("users").factory("Authentication",[function(){var a=this;return a._data={user:window.user},a._data}]),angular.module("users").factory("Users",["$resource",function(a){return a("users",{},{update:{method:"PUT"}})}]);